<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat General - DEADball</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .nav-links {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .nav-link {
            display: inline-block;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .chat-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            height: 600px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            background: #667eea;
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        
        .chat-header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .chat-header p {
            margin: 5px 0 0 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .message-username {
            font-weight: bold;
            color: #667eea;
        }
        
        .message-time {
            font-size: 12px;
            color: #999;
        }
        
        .message-text {
            color: #333;
            word-wrap: break-word;
        }
        
        .chat-input-container {
            padding: 20px;
            background: white;
            border-radius: 0 0 10px 10px;
            border-top: 2px solid #eee;
        }
        
        .chat-input-form {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .chat-send-btn {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .chat-send-btn:hover {
            background: #5568d3;
        }
        
        .chat-send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .online-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #10b981;
            border-radius: 50%;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%,
            100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        /* Estilos para scroll personalizado */
        
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
            transition: background 0.2s;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }
        
        .admin-badge {
            background: #fbbf24;
            color: #000;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 5px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="nav-links">
            <a href="index.html" class="nav-link">üéÆ Jugar</a>
            <a href="profile.html" class="nav-link">üë§ Perfil</a>
        </div>

        <div class="chat-container">
            <div class="chat-header">
                <h1>üí¨ Chat General</h1>
                <p>Conectado como <strong id="username">...</strong> <span class="online-indicator"></span></p>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="loading">Cargando mensajes...</div>
            </div>

            <div class="chat-input-container">
                <form class="chat-input-form" id="chatForm">
                    <input type="text" class="chat-input" id="messageInput" placeholder="Escribe un mensaje..." maxlength="500" autocomplete="off" required>
                    <button type="submit" class="chat-send-btn" id="sendBtn">Enviar</button>
                </form>
            </div>
        </div>
    </div>

    <!-- ================================================== -->
    <!-- LIBRER√çAS NECESARIAS -->
    <!-- ================================================== -->
    <!-- Socket.IO Client: librer√≠a para comunicaci√≥n en tiempo real -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- auth.js: nuestras funciones de autenticaci√≥n -->
    <script src="auth.js"></script>

    <!-- ================================================== -->
    <!-- SCRIPT INLINE: L√≥gica del chat en tiempo real -->
    <!-- ================================================== -->
    <script>
        // ================================================
        // PASO 1: VERIFICAR AUTENTICACI√ìN
        // ================================================
        // Si el usuario no est√° logueado, redirigir al login
        if (!estaLogueado()) {
            alert('Debes iniciar sesi√≥n para usar el chat');
            window.location.href = 'login.html';
        }

        // ================================================
        // PASO 2: OBTENER DATOS DEL USUARIO
        // ================================================
        const usuario = getUsuarioActual(); // {id, nombre, email, isAdmin}
        const isAdmin = usuario.isAdmin === 1; // true si es admin, false si no

        // Mostrar nombre del usuario en el header (con corona si es admin)
        document.getElementById('username').textContent = usuario.nombre + (isAdmin ? ' üëë' : '');

        // ================================================
        // PASO 3: CONECTAR A SOCKET.IO
        // ================================================
        // io() crea una conexi√≥n WebSocket con el servidor
        // Esta conexi√≥n es BIDIRECCIONAL y en TIEMPO REAL
        const socket = io('http://localhost:3000');

        // ================================================
        // PASO 4: OBTENER ELEMENTOS DEL DOM
        // ================================================
        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');

        // ================================================
        // FUNCI√ìN: CARGAR HISTORIAL DE MENSAJES
        // ================================================
        // Esta funci√≥n se ejecuta cuando se carga la p√°gina
        // Obtiene los √∫ltimos 50 mensajes del servidor
        async function cargarHistorial() {
            try {
                // Hacer petici√≥n HTTP normal para obtener el historial
                const response = await fetch('http://localhost:3000/api/chat/messages?limit=50');
                const messages = await response.json();

                // Limpiar el contenedor de mensajes
                chatMessages.innerHTML = '';

                if (messages.length === 0) {
                    // Si no hay mensajes, mostrar mensaje de bienvenida
                    chatMessages.innerHTML = '<div class="loading">No hay mensajes a√∫n. ¬°S√© el primero en escribir!</div>';
                } else {
                    // Mostrar cada mensaje del historial
                    messages.forEach(msg => {
                        mostrarMensaje(msg.id, msg.username, msg.message, msg.created_at);
                    });
                    // Hacer scroll hasta el final para ver los mensajes m√°s recientes
                    scrollToBottom();
                }
            } catch (error) {
                console.error('Error al cargar historial:', error);
                chatMessages.innerHTML = '<div class="loading">Error al cargar mensajes</div>';
            }
        }

        // ================================================
        // FUNCI√ìN: MOSTRAR UN MENSAJE EN EL CHAT
        // ================================================
        // Esta funci√≥n crea el HTML para un mensaje y lo a√±ade al chat
        function mostrarMensaje(messageId, username, message, timestamp) {
            // Crear elemento div para el mensaje
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            // dataset.messageId permite identificar este mensaje despu√©s (para eliminarlo)
            messageDiv.dataset.messageId = messageId;

            // ================================================
            // Formatear la fecha/hora
            // ================================================
            const fecha = new Date(timestamp);
            const tiempo = fecha.toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit'
            });

            // ================================================
            // Crear bot√≥n de eliminar SOLO si eres admin
            // ================================================
            const deleteButton = isAdmin ? `<button class="delete-btn" onclick="eliminarMensaje(${messageId})">üóëÔ∏è</button>` : '';

            // ================================================
            // A√±adir badge de ADMIN si el mensaje es del admin actual
            // ================================================
            const adminBadge = isAdmin && username === usuario.nombre ? '<span class="admin-badge">ADMIN</span>' : '';

            // ================================================
            // Construir el HTML del mensaje
            // ================================================
            // IMPORTANTE: usamos escapeHtml() para prevenir ataques XSS
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-username">${username}${adminBadge}</span>
                    <span>
                        <span class="message-time">${tiempo}</span>
                        ${deleteButton}
                    </span>
                </div>
                <div class="message-text">${escapeHtml(message)}</div>
            `;

            // A√±adir el mensaje al contenedor
            chatMessages.appendChild(messageDiv);
        }

        // ================================================
        // FUNCI√ìN: ESCAPAR HTML (Seguridad - Prevenir XSS)
        // ================================================
        // XSS (Cross-Site Scripting) es un ataque donde alguien
        // intenta inyectar c√≥digo JavaScript malicioso en un mensaje
        // 
        // Ejemplo sin escapeHtml():
        // Si alguien escribe: <script>alert('hackeo')
    </script>
    // ¬°Se ejecutar√≠a ese c√≥digo en todos los navegadores! // // Con escapeHtml(), ese texto se convierte en: // &lt;script&gt;alert('hackeo')&lt;/script&gt; // Y se muestra como texto, no se ejecuta function escapeHtml(text) { const div = document.createElement('div');
    div.textContent = text; // textContent escapa autom√°ticamente el HTML return div.innerHTML; // innerHTML devuelve el texto escapado } // ================================================ // FUNCI√ìN: HACER SCROLL AL FINAL DEL CHAT // ================================================
    function scrollToBottom() { // scrollTop = posici√≥n actual del scroll // scrollHeight = altura total del contenido // Al igualar ambos, nos vamos al final chatMessages.scrollTop = chatMessages.scrollHeight; } // ================================================
    // FUNCI√ìN: ELIMINAR MENSAJE (Solo Admin) // ================================================ function eliminarMensaje(messageId) { // Verificaci√≥n de seguridad en el frontend if (!isAdmin) return; // Pedir confirmaci√≥n antes de eliminar if (confirm('¬øEliminar
    este mensaje?')) { // Emitir evento a Socket.IO para eliminar el mensaje // El servidor verificar√° que realmente eres admin socket.emit('delete-message', { messageId }); } } // ================================================ // EVENTO: ENVIAR MENSAJE
    // ================================================ chatForm.addEventListener('submit', (e) => { e.preventDefault(); // Evitar recarga de p√°gina // Obtener el texto del mensaje y eliminar espacios al inicio/final const message = messageInput.value.trim();
    // Si el mensaje est√° vac√≠o, no hacer nada if (!message) return; // ================================================ // Emitir el mensaje a trav√©s de Socket.IO // ================================================ // socket.emit() env√≠a un evento al
    servidor // El servidor lo recibir√° y lo redistribuir√° a TODOS los clientes socket.emit('chat-message', { userId: usuario.id, username: usuario.nombre, message: message }); // ================================================ // Limpiar el input y
    volver a enfocar // ================================================ messageInput.value = ''; messageInput.focus(); }); // ================================================ // EVENTO SOCKET.IO: RECIBIR MENSAJE NUEVO // ================================================
    // Este evento se dispara cuando CUALQUIER usuario // (incluyendo t√∫ mismo) env√≠a un mensaje socket.on('chat-message', (data) => { mostrarMensaje(data.id, data.username, data.message, data.timestamp); scrollToBottom(); }); // ================================================
    // EVENTO SOCKET.IO: MENSAJE ELIMINADO // ================================================ // Cuando el admin elimina un mensaje, todos reciben esta notificaci√≥n socket.on('message-deleted', (data) => { // Buscar el mensaje en el DOM usando su ID
    const messageDiv = document.querySelector(`[data-message-id="${data.messageId}"]`); if (messageDiv) { // Animaci√≥n de desvanecimiento antes de eliminar messageDiv.style.transition = 'opacity 0.3s'; messageDiv.style.opacity = '0'; // Despu√©s de 300ms,
    eliminar el elemento del DOM setTimeout(() => messageDiv.remove(), 300); } }); // ================================================ // EVENTOS DE CONEXI√ìN DE SOCKET.IO // ================================================ // Cuando se establece la conexi√≥n
    socket.on('connect', () => { console.log('‚úÖ Conectado al chat'); sendBtn.disabled = false; // Habilitar el bot√≥n de enviar }); // Cuando se pierde la conexi√≥n socket.on('disconnect', () => { console.log('‚ùå Desconectado del chat'); sendBtn.disabled
    = true; // Deshabilitar el bot√≥n de enviar }); // ================================================ // INICIALIZACI√ìN: Cargar historial al abrir la p√°gina // ================================================ cargarHistorial();
    </script>
</body>

</html>