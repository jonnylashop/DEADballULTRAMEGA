<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Contrase√±a - DEADball</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .recovery-container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
        }
        
        .recovery-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .recovery-header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .recovery-header p {
            color: #666;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: #333;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #5568d3;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .error-message {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        
        .success-message {
            background: #efe;
            color: #3c3;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        
        .info-message {
            background: #e7f3ff;
            color: #0056b3;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .links {
            text-align: center;
            margin-top: 20px;
        }
        
        .links a {
            color: #667eea;
            text-decoration: none;
        }
        
        .links a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="recovery-container">
        <div class="recovery-header">
            <h1>üîë Recuperar Contrase√±a</h1>
            <p>Ingresa tu email para recuperar tu cuenta</p>
        </div>

        <div class="info-message">
            üìß Te enviaremos un c√≥digo de verificaci√≥n a tu email. Usa ese c√≥digo para crear una nueva contrase√±a.
        </div>

        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>

        <!-- PASO 1: Solicitar c√≥digo -->
        <div id="paso1">
            <form id="requestCodeForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required>
                </div>

                <button type="submit" class="btn" id="requestBtn">Enviar C√≥digo</button>
            </form>
        </div>

        <!-- PASO 2: Ingresar c√≥digo y nueva contrase√±a -->
        <div id="paso2" style="display: none;">
            <form id="resetPasswordForm">
                <input type="hidden" id="emailHidden">

                <div class="form-group">
                    <label for="code">C√≥digo de verificaci√≥n</label>
                    <input type="text" id="code" name="code" required maxlength="6" pattern="[0-9]{6}">
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                        C√≥digo de 6 d√≠gitos enviado a tu email
                    </small>
                </div>

                <div class="form-group">
                    <label for="newPassword">Nueva Contrase√±a</label>
                    <input type="password" id="newPassword" name="newPassword" required minlength="6">
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirmar Contrase√±a</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required>
                </div>

                <button type="submit" class="btn" id="resetBtn">Cambiar Contrase√±a</button>
            </form>
        </div>

        <div class="links" style="margin-top: 20px;">
            <p><a href="login.html">‚Üê Volver al login</a></p>
        </div>
    </div>

    <script src="auth.js"></script>
    <!-- ================================================== -->
    <!-- SCRIPT INLINE: Proceso de recuperaci√≥n de contrase√±a en 2 pasos -->
    <!-- ================================================== -->
    <script>
        // ================================================
        // PASO 1: SOLICITAR C√ìDIGO DE RECUPERACI√ìN
        // ================================================
        document.getElementById('requestCodeForm').addEventListener('submit', async(e) => {
            e.preventDefault();

            const email = document.getElementById('email').value;
            const btn = document.getElementById('requestBtn');

            // Deshabilitar bot√≥n durante el proceso
            btn.disabled = true;
            btn.textContent = 'Enviando...';

            try {
                // ================================================
                // Enviar petici√≥n para generar c√≥digo
                // ================================================
                // El backend:
                // 1. Verifica que el email exista
                // 2. Genera un c√≥digo de 6 d√≠gitos
                // 3. Lo guarda en la BD con expiraci√≥n de 15 minutos
                // 4. En producci√≥n, lo enviar√≠a por email
                const response = await fetch('http://localhost:3000/api/auth/request-password-reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al solicitar c√≥digo');
                }

                // ================================================
                // C√≥digo generado exitosamente
                // ================================================
                // Ocultar el paso 1 y mostrar el paso 2
                document.getElementById('paso1').style.display = 'none';
                document.getElementById('paso2').style.display = 'block';
                // Guardar el email en un input oculto para usarlo en el paso 2
                document.getElementById('emailHidden').value = email;

                mostrarMensaje('success', '‚úÖ C√≥digo enviado a tu email. Revisa tu bandeja de entrada.');
            } catch (error) {
                mostrarMensaje('error', error.message);
                // Rehabilitar bot√≥n si hay error
                btn.disabled = false;
                btn.textContent = 'Enviar C√≥digo';
            }
        });

        // ================================================
        // PASO 2: RESETEAR CONTRASE√ëA CON EL C√ìDIGO
        // ================================================
        document.getElementById('resetPasswordForm').addEventListener('submit', async(e) => {
            e.preventDefault();

            // Obtener todos los valores necesarios
            const email = document.getElementById('emailHidden').value;
            const code = document.getElementById('code').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const btn = document.getElementById('resetBtn');

            // ================================================
            // VALIDACIONES EN EL FRONTEND
            // ================================================
            // Verificar que las contrase√±as coincidan
            if (newPassword !== confirmPassword) {
                mostrarMensaje('error', 'Las contrase√±as no coinciden');
                return;
            }

            // Verificar longitud m√≠nima
            if (newPassword.length < 6) {
                mostrarMensaje('error', 'La contrase√±a debe tener al menos 6 caracteres');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Cambiando...';

            try {
                // ================================================
                // Enviar c√≥digo y nueva contrase√±a al backend
                // ================================================
                // El backend:
                // 1. Verifica que el c√≥digo sea correcto
                // 2. Verifica que no haya expirado
                // 3. Encripta la nueva contrase√±a con bcrypt
                // 4. Actualiza la BD
                // 5. Elimina el c√≥digo usado
                const response = await fetch('http://localhost:3000/api/auth/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        code,
                        newPassword
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al cambiar contrase√±a');
                }

                // ================================================
                // Contrase√±a cambiada exitosamente
                // ================================================
                mostrarMensaje('success', '‚úÖ Contrase√±a cambiada correctamente. Redirigiendo al login...');

                // Esperar 2 segundos antes de redirigir
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            } catch (error) {
                // Error: c√≥digo inv√°lido, expirado, etc.
                mostrarMensaje('error', error.message);
                btn.disabled = false;
                btn.textContent = 'Cambiar Contrase√±a';
            }
        });

        // ================================================
        // FUNCI√ìN AUXILIAR: Mostrar mensajes
        // ================================================
        function mostrarMensaje(tipo, mensaje) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');

            if (tipo === 'error') {
                errorDiv.textContent = mensaje;
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
            } else {
                successDiv.textContent = mensaje;
                successDiv.style.display = 'block';
                errorDiv.style.display = 'none';
            }
        }
    </script>
</body>

</html>